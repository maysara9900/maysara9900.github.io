## Overview

The first time I have seen this malware was in high school before at least 5-6 years, I still remember how widely spread it was back then, I had no idea what it does, all I remember that it was almost on all of my friends' USB drives and it was very hard to get rid from it. It was on every library computer in the city, as long as you plug your USB drive into the library computer, you will find a new executable created with a folder icon and named "صور حبيبتي" "My lover pictures" and I guess that was interesting enough for school students to click on it :)

After all these years, I have decided to search for this malware, I just was really curious about what it does, I thought that finding it again is going to be hard, but I made my mind to give it a try.

I decided to visit some libraries and plug my USB drive into their computers hoping that I will be able to get the malware after all these years. And guess what, I wasn't disappointed at all, I literally was able to get the malware from the first computer I plugged my USB drive in.

Now by just having the executable of the malware, what can we know? how can we analyze the malware and discover its functionality? that is what we are going to talk about.

In this brief note, I will write my findings after I analyzed this malware.
  

## Basic Static Anaylsis

  
In this step, we will try to collect basic information about the executable without opening it, this basic information gives us insights about what the malware does and helps us to build some theories before digging in deeply.

We start the basic static analysis by looking the at the executable header, I use a program called [Detect it easy](https://github.com/horsicq/Detect-It-Easy) and from there we can see that the malware is developed using .NET V2.0 compiler which means that the malware is written in C# programming language, we notice that the file is designed for 32-bit architectures, the malware size is 253 KB, we also notice that the malware is not packed.

We move on to check the strings in the malware, we start by checking the ANSI strings and we look for entries that don't look like noise and they are at least 5 characters. We notice several strings that look like functions names that are related to .NET and some libraries that are used in the malware, but nothing really interesting, we move on to UNICODE strings, and here we start to notice some really interesting strings, these are some of them:


-   SELECT Caption FROM Win32_OperatingSystem
-   \Framework.txt
-   vfe.temp
-   vrd.temp
-   name={0}&subject={1}&OS={2}&category={3}&priority={4}&message={5}&FileLocation={6}&email={7}&MyVer={..
-   The Computer Take ID:
-   http://ballgames.website/submit_ticket.php
-   http://ballgames.website/cache_update.php
-   /c shutdown -r -f -t 0
-   SELECT * FROM Win32_LogicalDiskToPartition
-   TaskManiger.exe
-   CMD.exe

Moving on from strings review, we now try to look at what DLL this exe imports, and we notice it imports one DLL which is mscoree.dll and it includes underneath it more DLLS like :

KERNEL32.DLL USER32.DLL OLEAUT32.DLL

The last step in our basic static analysis is to look at the malware resources, some malware store code in the resources section but in our case, there is only a folder icon there :)

By looking at the data above especially the strings I think we can build some assumptions. We are probably looking at a malware that is getting some information about the computer, writing some files to the disk, making a connection to an external server, and executing some commands.

All of these are just assumptions from the basic static analysis step, and we will see if they are correct or no in the next steps!


## Basic Dynamic Anaylsis


In this step, we will run the malware in a virtualized environment but before we run the malware we are going to run some programs to record the activity of the malware and examine how the malware affects the operating system.

-   [Process Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer) to monitor all active processes.
-   [Procmon](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon) to watch all file system activities so we can determine what files have been modified/used by the malware.
-   [Wireshark](https://www.wireshark.org/) to capture network packets.
-   [ApateDNS](https://www.fireeye.com/services/freeware/apatedns.html) to control all DNS responses, in our case, we will spoof the DNS response to point to the localhost 127.0.0.1

![Image](/assets/images/note1/ApateDNS.png)
-   [FakeNet](https://github.com/fireeye/flare-fakenet-ng) to simulate the network responses.

![Image](/assets/images/note1/fakenet.png)

-   [Regshot](https://sourceforge.net/projects/regshot/) to take a snapshot of the registry and then compare it with a second one before and after running the malware.


After running all these programs, we run the malware, notice that I am running the malware inside a virtualized environment that is not connected to the internet.

First of all, we notice by looking at [Process Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer) that the malware process has exited after few seconds and a new process has been created under the name of "TaskManiger.exe", we have seen this name before in the strings section.

We notice also that "TaskManiger.exe" is saved on "C:\Users\maysara\AppData\Local\TaskManiger.exe" and it has a size of 253 KB, the same size as the original file, and after doing some basic checking, it became obvious that the malware just copied itself on that path, TaskManiger is an identical copy of "صور حبيبتي.exe".

Now moving on to [Wireshark](https://www.wireshark.org/), we can see some TCP/HTTP traffic, we notice that a POST request has been made to http://ballgames.website/submit_ticket.php. The malware seems to collect some data about the computer as shown in the picture and post it to the malware server.


![Image](/assets/images/note1/wireshark.png)

Notice that the virtual environment is actually NOT connected to the internet and the malware shouldn't be able to make such a request, but thanks to [ApateDNS](https://www.fireeye.com/services/freeware/apatedns.html) we were able to fake the DNS response for the malware website and direct it to the localhost and then [FakeNet](https://github.com/fireeye/flare-fakenet-ng) sent a 200 response to the POST request.

![Image](/assets/images/note1/fakenetresponse.png)


Moving on to [Procmon](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon) we start looking at the activities and filtering them by the process name and operation, we notice that everything above is confirmed and also we notice that "TaskManiger.exe" is added to the startup programs so the malware can run every time you boot your computer. 

Alright, let's stop the malware and write down what we have found so far. So far we have noticed that malware does the following :

-   Copies itself to "C:\Users\maysara\AppData\Local\TaskManiger.exe", and the malware runs itself from there.
-   Adds itself to the startup programs so it can run every time the user boots his computer.
-   Collects data about the victim's computer and post it to an external server.

What a useless malware! right? so far the malware doesn't seem to be that harmful!


## Advanced Static Analysis


Now it is time to do reverse engineering and to take a look at the code, luckily the malware is written using .NET and that makes it easy to reverse engineer it, no need to look at Assembly level code, we will use [dnSpy](https://github.com/0xd4d/dnSpy) for this job. A bit of very important advice during this step, don't lose yourself into the details, try to get a high overview look first and then focus only on the code that looks useful, don't waste your time reading library code, also you will find a lot of weird code generated by the compiler, try to recognize and avoid that, here is an example of that weird looking code I found in the malware.

![Image](/assets/images/note1/uselesscode.png)

After tracing the executable entry point, we end up looking at a function called qouteCondition, this function creates two timers, one that runs every 40 seconds and calls another function called ExtractDomain, the other timer runs every 10 milliseconds and on each tick calls a function called IncreaseSolution, note that these timers are just initialized here and not run, after initializing the timers, the function calls OpenEmulator.

![Image](/assets/images/note1/qoutecondition.png)

By looking at OpenEmulator function, we notice that it checks if the malware is installed on the LocalApplicationFolder which is C:\Users\maysara\AppData\Local, and if not, it copies the malware there and starts a new process that runs the copied version, it also adds the copied executable to the startup programs list. After doing this the original process exits.

![Image](/assets/images/note1/taskmaniger.png)

If the malware is installed on LocalApplicationFolder which means that the malware that is being run is actually the copied version "TaskManiger.exe", OpenEmulator function starts the timers.

![Image](/assets/images/note1/timers.png)

Moving on to analyzing the timers functions, we will start with the first timer that calls IncreaseSolution function, this function runs every 10 milliseconds. The function is long and it contains a lot of hard to read code, but the purpose of that function is pretty obvious, which is to check if there is a removable USB drive installed and it copies the malware there under the name of "صور حبيبتي.exe".

![Image](/assets/images/note1/usb.png)

![Image](/assets/images/note1/lovepictures.png)

The second timer runs every 40 seconds and calls a function called ExtractDomain, the function starts a thread that runs another function called SeartchPage.

![Image](/assets/images/note1/extractdomain.png)

SeartchPage function is really interesting, it is the responsible function for making requests to the external server and also it seems that the malware does some actions based on the response that it receives from the server. The function checks some conditions and makes either a POST request to /submit_ticket or to /cache_update. it also handles the responses of each POST request and performs some actions based on these responses. 

In the pictures, it is shown that the code prepares the request body and collects data about the victim's machine.

![Image](/assets/images/note1/submit_ticket.png)

![Image](/assets/images/note1/cachupdate.png)

The response handling part for this function is really interesting but it is hard to analyze it fully since it depends on the server response and we don't have that for now, again the purpose of this stage is not to read the code line by line but rather to establish a high overview understanding of what the code does. 

After making a POST request to /submit_ticket the malware does some operations on vfe.temp vrd.temp files and also on \Framework.txt file, the function contains some ugly code that is hard to follow. 

After making a POST request to /cache_update the malware checks the response and if it contains "ok" the malware does some strings manipulation stuff and the malware starts a new process that runs an executable which I can't determine what it is at this point.

![Image](/assets/images/note1/runexe.png)

If the response contains "restart" command in it somewhere, the malware executes this /c shutdown -r -f -t 0 inside the CMD, and this will restart the victim's machine.

![Image](/assets/images/note1/shutdown.png)

Now at least the malware looks harmful in some ways, right? :D 

What is missing at this point? mainly we need to know how the server response will look like in order to know exactly what the malware is doing, and I think the main mystery here is to determine what is the executable that is being run in a new process after making a request to /cache_update. We are going to try to figure that out in the next stage.


## Advaned Dynamic Analysis


In this step we will run the malware inside the debugger and insert some breakspoints on the places that we are not sure about its functionality and examine the registrs and variables at that moment, also our aim now is to know what the malware does exactly after communicating with the server.

I spent some time inserting breakpoints here and there just to make sure that the flow of the code is as I understood it from the advanced static analysis step and fortunately everything was correct.

Now it is the time to see what the server response is, I used [POSTMAN](https://www.postman.com/) to make a fake request to the malware server to see what the response is, but guess what ... the server wasn't responding at all ....

I immediatly decided to create my own server inside the virtual environment and to respond to the malware using that server to see how the malware behaves.

I created a simple Node.Js server to response to /submit_ticket and /cache_update.

During the past step I have noticed that the malware expects the server to respond with a text that is splitted by some tokens, so I created my responses to be simillar to the original server responses as you see in the picture.

![Image](/assets/images/note1/server.png)

So now we have [ApateDNS](https://www.fireeye.com/services/freeware/apatedns.html) redirecting DNS requests to 127.0.01 and we have our server listening on 127.0.0.1 port 80 and by this, the malware should contact our server instead of the original server.

Now that we have all the pieces and everything is ready, we run the malware but before that, we insert some breakpoints at the main functions of the malware to help us examining the local variables values and also to be able to stop the malware and to take our time evaluating the results.

We notice that the malware does the following :

-   A post request firstly made to /submit_ticket with information about the victim's machine as shown in the picture
![Image](/assets/images/note1/submitticketbody.png)

-   The server response is stored in vfe.temp and vrd.temp files in the same malware directory

-   After 40 seconds the malware makes a POST request to /cache_update with the data that is stored in the .temp files as shown in the picture also with aditional data about the antiviruses that are installed on the system and data related to the .NET framwork.
![Image](/assets/images/note1/cacheupdatebody.png)

-   The mystery is solved, the response for /cache_update is stored in an .exe file and that file is launched in a new process
![Image](/assets/images/note1/folder.png)

-   These proceses are child proceses for TaskManiger.exe as shown in the picture
![Image](/assets/images/note1/exes.png)


## Conclusion


Now let's wrap up and summarize what have we found. Once you click on the malware it does the following :

-   Copies itself to "C:\Users\maysara\AppData\Local\TaskManiger.exe", and the malware runs itself from there in a new process.
-   Adds itself to the startup programs so it can run every time the user boots his computer.
-   Checks every 10 milliseconds if there is a removable device that has been inserted and then copies itself to that device under the name of "صور حبيبتي.exe"
-   Collects data about the victim's machine, data such as the OS version and the PC name.
-   Posts this data to http://ballgames.website/submit_ticket.php and the response is stored in vfe.temp and vrd.temp
-   If vfe.temp and vrd.temp files exist, the malware makes a POST request to http://ballgames.website/cache_update.php with the data that has been stored in these files and with additional data such as details about the .NET compiler and the antiviruses that are installed, the response for this request is either an .exe file that will be stored and launched in a new process, or a command that restarts the computer.
-   So simply put, the malware will collect some data about the computer and at some point, the server will respond back with another .exe malware to be run on the victim's machine in a new process.

This kind of malwares is usually used to perform DOS attacks, since this malware is installed on thousands of devices, the malware server can respond back with a simple program that makes HTTP requests to a certain server, and all the infected machines will run that program at the same time and this will cause the targeted server to be down.

How to check if I have this malware?

A good host-based signatures to use for detecting this program will be checking this path C:\Users\USER\AppData\Local\ for a file named "TaskManiger.exe" or checking if this file appears in the startup programs.
